You are an expert Python Backend Developer using FastAPI, SQLAlchemy, and httpx.
I need a robust asynchronous service function that syncs data from a specific external Bank API to my local database.
External API Details
Base URL: https://koshconnect-production.up.railway.app
Endpoint 1 (Account Details): GET /accounts/{account_id}
Response: {"account_id": "...", "bank_name": "...", "account_number_masked": "...", "account_type": "...", "balance": 1000.0}
Endpoint 2 (Transactions): GET /accounts/{account_id}/transactions
Response: [{"transaction_id": "...", "date": "...", "amount": 500, "type": "DEBIT", ...}, ...]
Database Models (Already Existing)
Assume these models exist in .models:
BankAccount: Has external_account_id (unique), user_id, balance, etc.
Transaction: Has external_transaction_id (unique), bank_account_id, source="BANK".
The Task
Write a Python file services/bank_sync.py with a single async function:
async def fetch_and_sync_bank_data(user_id: int, target_account_id: str, db: Session):
Logic Requirements
Fetch Account: Call Endpoint 1.
If the account does NOT exist in my local bank_accounts table, create it (linked to user_id).
If it DOES exist, update the balance.
Fetch Transactions: Call Endpoint 2.
Loop through the results.
Check if a transaction with this transaction_id already exists locally (in the external_transaction_id column).
If it does NOT exist, insert it into the transactions table.
Important: Map the external transaction_id to my local external_transaction_id column.
Set source to "BANK".
Error Handling: Wrap API calls in try/except blocks (handle network errors gracefully).
Return: A dictionary with summary stats (e.g., {"new_transactions": 5, "status": "success"}).
Generate only the Python code.
